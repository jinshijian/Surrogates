---
title: "Surrogates"
author: "Jinshi"
date: "July 15, 2019"
output: html_document
---

```{r load packages, message=FALSE, cache=FALSE, echo=FALSE, warning=FALSE}
# install.packages('kableExtra')
# install.packages('factoextra')
library(drake)
library(data.table)
library(lubridate)
library(kableExtra)
library(gridExtra)
library(cowplot)
library(knitr)
library("ggpubr")
library(tidyverse)
library(ggmap)
library(maps)
library(mapdata)
library(hexbin)
library(ggplot2)
theme_set(theme_bw())
library(devtools)
# install_github("vqv/ggbiplot")
library(ggbiplot)
library(rpart)
library(egg)
library(ggbeeswarm)
# library(devtools)
# install_github("vqv/ggbiplot")
library(ggbiplot)

source('functions.R')
source('drake.R')

library(dplyr)
library(ncdf4)

```


```{r setup, echo=FALSE}
# Set chunks defaults; these options will be applied to all subsequent chunks
knitr::opts_chunk$set(results = 'hide', message = TRUE, include = TRUE, 
                      echo = FALSE, warning = FALSE,
                      fig.height = 6, fig.width = 8, cache = FALSE)
```

## Prepare data
### Read model statistics for temperature surrogate and data processing
```{r temperature statistics, results='hide', message=FALSE, include=FALSE}
# model statistics
SRDB <- readd(SRDB)
DGRsD <- readd(DGRsD)
DGRsD_TS <- readd(DGRsD_TS)
DGRsD_SWC <- readd(DGRsD_SWC)
GPT <- readd(GPT)
GPT %>% 
  filter(MAT < 40 & MAT > -40 & MAP < 6000) ->
  GPT

# prepare data for temperature surrogate analysis
t_results <- readd(t_results)
t_results %>% na.omit() -> t_results
# t_results %>% rename (Study_number = sub_site.Study_number.1., Measure_year = sub_siteID.Measure_Year.1., SiteID = var_site.j.) -> t_results
colnames(t_results)[1:3] <- c("Study_number", "Measure_year", "SiteID")
t_results %>% select(Study_number, Measure_year, SiteID) %>% unique()

# group R2 difference into three groups: low (Tsoil explianed less RS variability), mid (same), and high (Tsoil explained more RS variability)
t_results %>% mutate(Diff = first_R2 - first_Tm_R2) -> t_results
t_results <- set_r2_dif_group(low = -0.1, high = 0.1, sdata = t_results)

# use left join and get Ts_depth information
DGRsD_TS %>% 
  select(Study_number, SiteID, TsDepth, Latitude, Longitude, MAP_Del, MAT_Del) %>% group_by(Study_number, SiteID) %>% 
  dplyr::summarise(Ts_depth = mean(TsDepth), Lat = mean(Latitude), Lon = mean(Longitude), MAP = mean(MAP_Del), MAT = mean(MAT_Del)) %>%
  right_join(t_results, by = c("Study_number", "SiteID")) -> t_results
 
# more numeric factors from SRDB_V4
SRDB %>% select(Study_number, SiteID, Elevation) %>% group_by (Study_number, SiteID) %>%
 dplyr:: summarise(Ele = mean(Elevation, na.rm = TRUE)) %>% 
  right_join(t_results, by = c("Study_number", "SiteID")) -> t_results

# more caetgorial factors from SRDB_V4
SRDB %>% select(Study_number, SiteID, Biome_group, Ecosystem_group, Leaf_group, Drainage_group) %>% 
  unique() %>%
  right_join(t_results, by = c("Study_number", "SiteID")) -> t_results

# some testing code
# for the SLR, find out those suties and sites with negative slope
t_results %>% filter (first_b < 0) %>% select (Study_number) %>% unique()
t_results %>% filter (poly_c > 0) %>% select (Study_number, poly_c) %>% unique() %>% arrange(desc(poly_c))


# Prepare data for precipitation as surrogate of SWC analysis
swc_results <- readd(swc_results)
swc_results %>% na.omit() -> swc_results
# swc_results %>% rename(Study_number = sub_site.Study_number.1., SiteID = var_site.j., Measure_year = sub_siteID.Measure_Year.1. ) -> swc_results
colnames(swc_results)[1:3] <- c("Study_number", "Measure_year", "SiteID")

# Calculate threshold 
swc_results %>% mutate(thd_swc = -poly_b/(2*poly_c), thd_pm = -poly_pm_b/(2*poly_pm_c)) -> swc_results

# 152 GWC sites and 375 VWC sites
swc_results %>% filter(var_swc == "GWC") %>% select(Study_number, SiteID) %>% unique () %>% nrow()
swc_results %>% filter(var_swc == "VWC") %>% select(Study_number, SiteID) %>% unique () %>% nrow()

# use left join and get Ts_depth information
DGRsD_SWC %>% 
  select(Study_number, SiteID, SWC_Depth, Latitude, Longitude, MAP_Del, MAT_Del) %>% group_by(Study_number, SiteID) %>% 
  dplyr::summarise(SWCdepth = mean(SWC_Depth), Lat = mean(Latitude), Lon = mean(Longitude), MAP = mean(MAP_Del), MAT = mean(MAT_Del)) %>%
  right_join(swc_results, by = c("Study_number", "SiteID")) -> swc_results
 
# more numeric factors from SRDB_V4
SRDB %>% select(Study_number, SiteID, Elevation) %>% group_by (Study_number, SiteID) %>%
 dplyr:: summarise(Ele = mean(Elevation, na.rm = TRUE)) %>% 
  right_join(swc_results, by = c("Study_number", "SiteID")) -> swc_results

# more caetgorial factors from SRDB_V4
SRDB %>% select(Study_number, SiteID, Biome_group, Ecosystem_group, Leaf_group, Drainage_group) %>% 
  unique() %>%
  right_join(swc_results, by = c("Study_number", "SiteID")) -> swc_results

# prepare data for residual analysis
t_residual_results <- readd(t_residual_results)
swc_residual_results <- readd(swc_residual_results)
```


## get clay, BD, and OC from HWSD
```{r, include = FALSE}
swc_results = get_clayOCBD(swc_results, j=1, "BD")
swc_results = get_clayOCBD(swc_results, j=2, "Clay")
swc_results = get_clayOCBD(swc_results, j=3, "OC")
```


## Sample reresentative figure
```{r Figure 1, fig.height=4, fig.width=8}

# density
ggplot(aes(MAT), data = GPT) + geom_histogram() + 
  # scale_fill_distiller(palette = "YlGnBu") +
  scale_fill_continuous(low = "gray", high = "black") +
  xlab(expression(Temperature~"( "~degree~C~")")) +
  ylab(expression(Precipitation~"(mm"~month^{-1}~")")) +
  geom_point(data = DGRsD_TS,
             aes(Tm_Del, Pm_Del, col = Climate_type),
             alpha = 0.15,
             shape = 4,
             size = 2,
             legend = FALSE) +
  theme (legend.position = c(0.25, 0.65),
         legend.title = element_blank(),
         legend.background = element_rect(fill = alpha("white", 0), size = 0.75)) +
  guides(fill = F, colour = guide_legend(override.aes = list(alpha=1)))


# plot Figure1 - sites with Tsoil and SWC vs all data from DGRsD
ggplot(aes(MAT, MAP), data = GPT) + 
  geom_hex(bins = 50) + 
  # scale_fill_distiller(palette = "YlGnBu") +
  scale_fill_continuous(low = "gray", high = "black") +
  xlab(expression(Temperature~"( "~degree~C~")")) +
  ylab(expression(Precipitation~"(mm"~month^{-1}~")")) +
  geom_point(data = DGRsD_TS,
             aes(Tm_Del, Pm_Del, col = Climate_type),
             alpha = 0.5,
             shape = 4,
             size = 2,
             legend = FALSE) +
  scale_color_manual(labels = c("a", "b", "c", "d"),
                     values = c("#E41A1C", "#377EB8", "#4DAF4A", "#984EA3")) +
  theme (legend.position = "none",
         legend.title = element_blank(),
         legend.background = element_rect(fill = alpha("white", 0), size = 0.75)) +
  guides(fill = F, colour = guide_legend(override.aes = list(alpha=1))) -> 
  p1
  
ggplot(aes(MAT, MAP), data = GPT) + 
  geom_hex(bins = 50) + 
  # theme (legend.position = c(0.25, 0.65)) +
  # scale_fill_distiller(palette = "YlGnBu") +
  scale_fill_continuous(low = "gray", high = "black") +
  xlab(expression(Temperature~"( "~degree~C~")")) +
  ylab(expression(Precipitation~"(mm"~month^{-1}~")")) ->
  p2
  p2 + geom_jitter(data = DGRsD_SWC, 
              shape = 4,
              size = 2,
              aes(Tm_Del, Pm_Del, col = Climate_type),
              alpha = 0.5) +
    theme (legend.title = element_blank(),
           axis.title.y = element_blank(),
           axis.text.y = element_blank(),
           legend.background = element_rect(fill = alpha("white", 0), size = 0.75)) +
    scale_color_manual(labels = c("Tropic", "Arid", "Temperate", "Snow"),
                       values = c("#E41A1C", "#377EB8", "#4DAF4A", "#984EA3")) -> 
  p2

plot_grid(p1, p2, labels = c( "(a)", "(b)" )
          , vjust = 3, hjust = c(-4, -1.65), ncol = 2,
          rel_widths = c(1,1.15))

# RColorBrewer::brewer.pal(8, "Set1") # get color code
# ggsave("outputs/Figure1. Site_distribution.jpg", width = 8, height = 4, dpi = 300, units = "in")

```


## Tair as surrogate of Tsoil analysis
```{r Figure S2 - Temperature surrogate percentage summaruy}
# R2 difference if use SLR model
t_results %>% mutate(Dif_SLR = case_when(first_R2 - first_Tm_R2 < -0.1 ~ "Low"
                                          , first_R2 - first_Tm_R2 > 0.1 ~ "High"
                                          , TRUE ~ "Same")) %>% select(SiteID, first_R2, first_Tm_R2, Dif_SLR) %>% 
  dplyr::count(Dif_SLR) %>% mutate (freq = round(n/sum(n) * 100,2)) %>% 
  ggplot(aes(x="", y=freq, fill = Dif_SLR)) +
  geom_bar(width = 1, stat = "identity") -> p1

p1 = p1 + coord_polar("y", start=0) + geom_text(aes(label = paste0(round(freq, 2), "%")), position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values=c("violet", "orange", "gray")) +
  labs(x = NULL, y = NULL, fill = NULL, title = expression("(a) LR"~R^{2}~"difference")) +
  theme_classic() + theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "bottom",
          plot.title = element_text(hjust = 0.5, color = "black"))


# plot the percentage of SLR p<=0.05 and p>0.05
t_results %>% mutate(p_group = ifelse(p_b < 0.05, "p<0.5", "p>=0.5")) %>% select(p_group) %>% 
  dplyr::count(p_group) %>% mutate (freq = round(n/sum(n) * 100,2)) %>% 
  ggplot(aes(x="", y=freq, fill = p_group)) +
  geom_bar(width = 1, stat = "identity") -> p2

p2 = p2 + coord_polar("y", start=0) + geom_text(aes(label = paste0(round(freq, 2), "%")), position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values=c("pink", "cyan")) +
  labs(x = NULL, y = NULL, fill = NULL, title = expression("(b) LR(R"[S]~"-vs-T"[soil]~")")) +
  theme_classic() + theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "bottom",
          plot.title = element_text(hjust = 0.5, color = "black"))


# plot the percentage of SLR p<=0.05 and p>0.05 using air temperature
t_results %>% mutate(p_group = ifelse(p_Tm_b < 0.05, "p<0.5", "p>=0.5")) %>% select(p_group) %>% 
  dplyr::count(p_group) %>% mutate (freq = round(n/sum(n) * 100,2)) %>% 
  ggplot(aes(x="", y=freq, fill = p_group)) +
  geom_bar(width = 1, stat = "identity") -> p3

p3 = p3 + coord_polar("y", start=0) + geom_text(aes(label = paste0(round(freq, 2), "%")), position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values=c("pink", "cyan")) +
  labs(x = NULL, y = NULL, fill = NULL, title = expression("(c) LR(R"[S]~"-vs-T"[air]~")")) +
  theme_classic() + theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "bottom",
          plot.title = element_text(hjust = 0.5, color = "black"))


# R2 difference if use Polynomial model
t_results %>% mutate(Dif_poly = case_when(poly_R2 - poly_Tm_R2 < -0.1 ~ "Low"
                                          , poly_R2 - poly_Tm_R2 > 0.1 ~ "High"
                                          , TRUE ~ "Same")) %>% select(SiteID, poly_R2, poly_Tm_R2, Dif_poly) %>% 
  dplyr::count(Dif_poly) %>% mutate (freq = round(n/sum(n) * 100,2)) %>% 
  ggplot(aes(x="", y=freq, fill = Dif_poly)) +
  geom_bar(width = 1, stat = "identity") -> p4

p4 = p4 + coord_polar("y", start=0) + geom_text(aes(label = paste0(round(freq, 2), "%")), position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values=c("violet", "orange", "gray")) +
  labs(x = NULL, y = NULL, fill = NULL, title = expression("(d) PR"~R^{2}~"difference")) +
  theme_classic() + theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "bottom",
          plot.title = element_text(hjust = 0.5, color = "black"))

# plot the percentage of polynomial p<=0.05 and p>0.05
t_results %>% mutate(p_group = ifelse(p_poly_b < 0.05 | p_c < 0.05, "p<0.5", "p>=0.5")) %>% select(p_group) %>% 
  dplyr::count(p_group) %>% mutate (freq = round(n/sum(n) * 100,2)) %>% 
  ggplot(aes(x="", y=freq, fill = p_group)) +
  geom_bar(width = 1, stat = "identity") -> p5

p5 = p5 + coord_polar("y", start=0) + geom_text(aes(label = paste0(round(freq, 2), "%")), position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values=c("pink", "cyan")) +
  labs(x = NULL, y = NULL, fill = NULL, title = expression("(e) PR(R"[S]~"-vs-T"[soil]~")")) +
  theme_classic() + theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "bottom",
          plot.title = element_text(hjust = 0.5, color = "black"))


# plot the percentage of polynomial p<=0.05 and p>0.05
t_results %>% mutate(p_group = ifelse(p_poly_Tm_b < 0.05 | p_Tm_c < 0.05, "p<0.5", "p>=0.5")) %>% select(p_group) %>% 
  dplyr::count(p_group) %>% mutate (freq = round(n/sum(n) * 100,2)) %>% 
  ggplot(aes(x="", y=freq, fill = p_group)) +
  geom_bar(width = 1, stat = "identity") -> p6

p6 = p6 + coord_polar("y", start=0) + geom_text(aes(label = paste0(round(freq, 2), "%")), position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values=c("pink", "cyan")) +
  labs(x = NULL, y = NULL, fill = NULL, title = expression("(f) PR(R"[S]~"-vs-T"[air]~")")) +
  theme_classic() + theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "bottom",
          plot.title = element_text(hjust = 0.5, color = "black"))

plot_grid(p1, p2, p3
          , p4, p5, p6, ncol = 3)

# ggsave("outputs/FigureS2.jpg", width = 8, height = 6, dpi = 300, units = "in")

# t_results %>% mutate(p_group = ifelse(p_poly_b <= 0.05 | p_c <= 0.05, "Yes", "No")) %>% select(SiteID, p_poly_b, p_c, p_group)
t_results %>% filter(p_b >= 0.05 & p_poly_b >= 0.05) %>% nrow() / nrow(t_results)
```


#### outlier detecting and removing for RMSE
```{r}
# set the cutoff for outlier
# distance = 4/n or 4/(n-k-1)
# dist = 0.005

# Select slope values
bind_rows(
  t_results %>% select(`Tsoil` = first_b, `Tair` = first_Tm_b, p_b, p_Tm_b) %>% 
    filter(p_b < 0.05 & p_Tm_b < 0.05) %>% 
    # filter(Tsoil < 1.5) %>%  # remove one outlier, that one significantly effect the relationship
    mutate(Model = 'LR', Model_stat = 'Slope'),
  
  t_results %>% select(`Tsoil` = poly_b, `Tair` = poly_Tm_b, p_poly_b, p_poly_Tm_b, p_c, p_Tm_c) %>% 
    filter(p_poly_b < 0.05 | p_c < 0.05 & p_poly_Tm_b < 0.05 | p_Tm_c < 0) %>% 
    # filter(Tsoil > -100 & Tsoil < 10) %>% # remove two outlier, that one significantly effect the relationship
    mutate(Model = 'PR', Model_stat = 'Slope')
) -> t_surrogate_beta
t_surrogate_beta <- outlier_test(t_surrogate_beta, t_surrogate_beta$Tair, t_surrogate_beta$Tsoil)
t_surrogate_beta <- t_surrogate_beta %>% filter(Tsoil < 1.5)  #4608 and 4609

# Select R2 values
bind_rows(
  t_results %>% select(`Tsoil` = first_R2, `Tair` = first_Tm_R2, p_b, p_Tm_b) %>% 
    filter(p_b < 0.05 & p_Tm_b < 0.05) %>% 
    mutate(Model = 'LR', Model_stat = 'R2'),
  
  t_results %>% select(`Tsoil` = poly_R2, `Tair` = poly_Tm_R2, p_poly_b, p_poly_Tm_b, p_c, p_Tm_c) %>% 
    filter(p_poly_b < 0.05 | p_c < 0.05 & p_poly_Tm_b < 0.05 | p_Tm_c < 0) %>% 
    mutate(Model = 'PR', Model_stat = 'R2')
) -> t_surrogate_r2
t_surrogate_r2 <- outlier_test(t_surrogate_r2, t_surrogate_r2$Tair, t_surrogate_r2$Tsoil)

# Select RMSE values
bind_rows(
  t_results %>% select(`Tsoil` = slr_RMSE, `Tair` = slr_Tm_RMSE, p_b, p_Tm_b) %>%
    filter(p_b < 0.05 & p_Tm_b < 0.05) %>%
    filter(Tsoil < 2) %>% # only 3 points, hide them
    mutate(Model = 'LR', Model_stat = 'RMSE'),

  t_results %>% select(`Tsoil` = poly_RMSE, `Tair` = poly_Tm_RMSE, p_poly_b, p_poly_Tm_b, p_c, p_Tm_c) %>%
    filter(p_poly_b < 0.05 | p_c < 0.05 & p_poly_Tm_b < 0.05 | p_Tm_c < 0) %>%
    filter(Tsoil < 2) %>%
    mutate(Model = 'PR', Model_stat = 'RMSE')
) -> t_surrogate_rmse
t_surrogate_rmse <- outlier_test(t_surrogate_rmse, t_surrogate_rmse$Tair, t_surrogate_rmse$Tsoil)

# Select d values
bind_rows(
  t_results %>% select(`Tsoil` = slr_d, `Tair` = slr_Tm_d, p_b, p_Tm_b) %>% 
    filter(p_b < 0.05 & p_Tm_b < 0.05) %>% 
    mutate(Model = 'LR', Model_stat = 'd'),
  
  t_results %>% select(`Tsoil` = poly_d, `Tair` = poly_Tm_d, p_poly_b, p_poly_Tm_b, p_c, p_Tm_c) %>% 
    filter(p_poly_b < 0.05 | p_c < 0.05 & p_poly_Tm_b < 0.05 | p_Tm_c < 0) %>% 
    mutate(Model = 'PR', Model_stat = 'd')
) -> t_surrogate_d
t_surrogate_d <- outlier_test(t_surrogate_d, t_surrogate_d$Tair, t_surrogate_d$Tsoil)
  
# Select EF values
bind_rows(
  t_results %>% select(`Tsoil` = slr_EF, `Tair` = slr_Tm_EF, p_b, p_Tm_b) %>% 
    filter(p_b < 0.05 & p_Tm_b < 0.05) %>% 
    mutate(Model = 'LR', Model_stat = 'EF'),
  
  t_results %>% select(`Tsoil` = poly_EF, `Tair` = poly_Tm_EF, p_poly_b, p_poly_Tm_b, p_c, p_Tm_c) %>% 
    filter(p_poly_b < 0.05 | p_c < 0.05 & p_poly_Tm_b < 0.05 | p_Tm_c < 0) %>% 
    mutate(Model = 'PR', Model_stat = 'EF')
) -> t_surrogate_ef

t_surrogate_ef <- outlier_test(t_surrogate_ef, t_surrogate_ef$Tair, t_surrogate_ef$Tsoil)

t_surrogate <- bind_rows(t_surrogate_beta, t_surrogate_r2, t_surrogate_rmse, t_surrogate_d, t_surrogate_ef)

```


#### plot the model statistic comparison
```{r temperature statistic evaluation comparison}
scaleFUN <- function(x) sprintf("%.1f", x) # x and y axis label to 1 decimal

t_surrogate_beta %>% 
  ggplot(aes(x = Tair, y = Tsoil, color = outlier )) + geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", col = "red", fill = "orange") +
  geom_abline(intercept = 0, slope = 1, col = "red", linetype = "dotdash", size = 1.25) +
  facet_wrap (Model ~ Model_stat, nrow = 2, scales = "free") +
  # scale_x_continuous(trans = "log2") +
  # scale_y_continuous(trans = "log2") +
  scale_x_continuous(labels=scaleFUN) +
  scale_y_continuous(labels=scaleFUN) -> p_rmse

t_surrogate_beta %>% 
  filter(outlier == "No") %>% 
  filter(Tsoil < 1.5) %>% # remove two studies (4608 and 4609), these two studies have significant opposite trend
  ggplot(aes(x = Tair, y = Tsoil, color = outlier )) + geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", col = "red", fill = "orange") +
  geom_abline(intercept = 0, slope = 1, col = "red", linetype = "dotdash", size = 1.25) +
  facet_wrap (Model ~ Model_stat, nrow = 2, scales = "free") +
  # scale_x_continuous(trans = "log2") +
  # scale_y_continuous(trans = "log2") +
  scale_x_continuous(labels=scaleFUN) +
  scale_y_continuous(labels=scaleFUN) + theme(legend.position = "none") +
  theme(axis.title.y = element_blank()) -> p_rmse_outlrm

plot_grid(p_rmse, p_rmse_outlrm, rel_widths = c(0.575, 0.425))

# Need do some outlier test, see Bahn analysis
t_surrogate %>% 
  filter(Model_stat != "R2") %>%
  ggplot(aes(x = Tair, y = Tsoil, col = outlier )) + geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", col = "red", fill = "orange") +
  geom_abline(intercept = 0, slope = 1, col = "black", linetype = "dotdash", size = 1.25) +
  facet_wrap (Model ~ Model_stat, nrow = 2, scales = "free") +
  # scale_x_continuous(trans = "log2") +
  # scale_y_continuous(trans = "log2") +
  scale_x_continuous(labels=scaleFUN) +
  scale_y_continuous(labels=scaleFUN) +
  labs(x=expression(R[S]~"-vs-"~T[air]),
       y=expression(R[S]~"-vs-"~T[soil]))

# ggsave("outputs/FigureS3.jpg", width = 8, height = 5, dpi = 300, units = "in")

t_surrogate %>% 
  filter(outlier == "No" & Model_stat != "R2") %>% 
  ggplot(aes(x = Tair, y = Tsoil)) + 
  geom_hex(bins = 15) +
  # scale_fill_distiller(palette = "YlGnBu") +
  # scale_fill_continuous(low = "gray", high = "black") +
  geom_smooth(method = "lm", col = "blue", fill = "white") +
  geom_abline(intercept = 0, slope = 1, col = "red", linetype = "dotdash", size = 0.75) +
  facet_wrap (Model ~ Model_stat, nrow = 2, scales = "free") +
  # scale_x_continuous(trans = "log2") +
  # scale_y_continuous(trans = "log2") +
  scale_x_continuous(labels=scaleFUN) +
  scale_y_continuous(labels=scaleFUN) +
  theme(legend.position = "none") +
  labs(x=expression(R[S]~"-vs-"~T[air]),
       y=expression(R[S]~"-vs-"~T[soil]))
   

# ggsave("outputs/Figure2.jpg", width = 8, height = 5, dpi = 300, units = "in")

t_surrogate_beta %>% filter(cooks_dist >= 0.005)
t_surrogate_beta %>% filter(Tsoil > 1 & Model == 'LR')
t_surrogate_beta %>% filter(Tsoil > 10)

```



## Precipitation as a surrogate of SWC
```{r SWC surrogate percentage summary}

# only 171 site with significant polynomial trend
swc_results %>% select(`SWC` = poly_d, `Pm` = poly_pm_d, p_poly_b, p_poly_pm_b, p_c, p_pm_c) %>% 
  filter(p_poly_b < 0.05 | p_c < 0.05)

swc_results %>% select(`SWC` = poly_d, `Pm` = poly_pm_d, p_poly_b, p_poly_pm_b, p_c, p_pm_c) %>% 
  filter(p_poly_pm_b < 0.05 | p_pm_c < 0.50)

swc_results %>% mutate(p_group = ifelse((p_poly_b < 0.05 | p_c < 0.05), "p<0.5", "p>=0.5")) %>% 
  select(p_poly_b, p_c, p_group)


# R2 difference if use SLR model
swc_results %>% mutate(Dif_SLR = case_when(first_R2 - first_pm_R2 < -0.1 ~ "Low"
                                          , first_R2 - first_pm_R2 > 0.1 ~ "High"
                                          , TRUE ~ "Same")) %>% select(SiteID, first_R2, first_pm_R2, Dif_SLR) %>% 
  dplyr::count(Dif_SLR) %>% mutate (freq = round(n/sum(n) * 100,2)) %>% 
  ggplot(aes(x="", y=freq, fill = Dif_SLR)) +
  geom_bar(width = 1, stat = "identity") -> p1

p1 = p1 + coord_polar("y", start=0) + geom_text(aes(label = paste0(round(freq, 2), "%")), position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values=c("violet", "orange", "gray")) +
  labs(x = NULL, y = NULL, fill = NULL, title = expression("(a) LR"~R^{2}~"difference")) +
  theme_classic() + theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "bottom",
          plot.title = element_text(hjust = 0.5, color = "black"))

# plot the percentage of SLR p<=0.05 and p>0.05
swc_results %>% mutate(p_group = ifelse(p_b < 0.05, "p<0.5", "p>=0.5")) %>% select(p_group) %>% 
  dplyr::count(p_group) %>% mutate (freq = round(n/sum(n) * 100,2)) %>% 
  ggplot(aes(x="", y=freq, fill = p_group)) +
  geom_bar(width = 1, stat = "identity") -> p2

p2 = p2 + coord_polar("y", start=0) + geom_text(aes(label = paste0(round(freq, 2), "%")), position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values=c("pink", "cyan")) +
  labs(x = NULL, y = NULL, fill = NULL, title = expression("(b) LR(R"[S]~"-vs-"~SWC~")")) +
  theme_classic() + theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "bottom",
          plot.title = element_text(hjust = 0.5, color = "black"))


# plot the percentage of SLR p<=0.05 and p>0.05 using precipitation
swc_results %>% mutate(p_group = ifelse(p_pm_b < 0.05, "p<0.5", "p>=0.5")) %>% select(p_group) %>% 
  dplyr::count(p_group) %>% mutate (freq = round(n/sum(n) * 100,2)) %>% 
  ggplot(aes(x="", y=freq, fill = p_group)) +
  geom_bar(width = 1, stat = "identity") -> p3

p3 = p3 + coord_polar("y", start=0) + geom_text(aes(label = paste0(round(freq, 2), "%")), position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values=c("pink", "cyan")) +
  labs(x = NULL, y = NULL, fill = NULL, title = expression("(c) LR(R"[S]~"-vs-"~P[m]~")")) +
  theme_classic() + theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "bottom",
          plot.title = element_text(hjust = 0.5, color = "black"))


# R2 difference if use Polynomial model
swc_results %>% mutate(Dif_poly = case_when(poly_R2 - poly_pm_R2 < -0.1 ~ "Low"
                                          , poly_R2 - poly_pm_R2 > 0.1 ~ "High"
                                          , TRUE ~ "Same")) %>% select(SiteID, poly_R2, poly_pm_R2, Dif_poly) %>% 
  dplyr::count(Dif_poly) %>% mutate (freq = round(n/sum(n) * 100,2)) %>% 
  ggplot(aes(x="", y=freq, fill = Dif_poly)) +
  geom_bar(width = 1, stat = "identity") -> p4

p4 = p4 + coord_polar("y", start=0) + geom_text(aes(label = paste0(round(freq, 2), "%")), position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values=c("violet", "orange", "gray")) +
  labs(x = NULL, y = NULL, fill = NULL, title = expression("(d) PR"~R^{2}~"difference")) +
  theme_classic() + theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "bottom",
          plot.title = element_text(hjust = 0.5, color = "black"))

# plot the percentage of polynomial p<=0.05 and p>0.05
swc_results %>% mutate(p_group = ifelse((p_poly_b < 0.05 | p_c < 0.05), "p<0.5", "p>=0.5")) %>% select(p_group) %>% 
  dplyr::count(p_group) %>% mutate (freq = round(n/sum(n) * 100,2)) %>% 
  ggplot(aes(x="", y=freq, fill = p_group)) +
  geom_bar(width = 1, stat = "identity") -> p5

p5 = p5 + coord_polar("y", start=0) + geom_text(aes(label = paste0(round(freq, 2), "%")), position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values=c("pink", "cyan")) +
  labs(x = NULL, y = NULL, fill = NULL, title = expression("(e) PR(R"[S]~"-vs-"~SWC~")")) +
  theme_classic() + theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "bottom",
          plot.title = element_text(hjust = 0.5, color = "black"))


# plot the percentage of polynomial p<=0.05 and p>0.05
swc_results %>% mutate(p_group = ifelse(p_poly_pm_b < 0.05 | p_pm_c < 0.05, "p<0.5", "p>=0.5")) %>% select(p_group) %>% 
  dplyr::count(p_group) %>% mutate (freq = round(n/sum(n) * 100,2)) %>% 
  ggplot(aes(x="", y=freq, fill = p_group)) +
  geom_bar(width = 1, stat = "identity") -> p6

p6 = p6 + coord_polar("y", start=0) + geom_text(aes(label = paste0(round(freq, 2), "%")), position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values=c("pink", "cyan")) +
  labs(x = NULL, y = NULL, fill = NULL, title = expression("(f) PR(R"[S]~"-vs-"~P[m]~")")) +
  theme_classic() + theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "bottom",
          plot.title = element_text(hjust = 0.5, color = "black"))

plot_grid(p1, p2, p3, p4, p5, p6, ncol = 3)

# ggsave("outputs/FigureS4.jpg", width = 8, height = 6, dpi = 300, units = "in")

swc_results %>% mutate(p_group = ifelse(p_poly_b <= 0.05 | p_c <= 0.05, "Yes", "No")) %>% select(SiteID, p_poly_b, p_c, p_group)
  
```


#### Outlier detecting and data preparation
```{r}
# Select beta(slope) values
bind_rows(
  swc_results %>% select(`SWC` = first_b, `Pm` = first_pm_b, p_b, p_pm_b) %>% 
    filter(p_b < 0.05 & p_pm_b < 0.05) %>% 
    filter(SWC < 1) %>% #remove two outliers
    mutate(Model = 'LR', Model_stat = 'Slope'),
  
  swc_results %>% select(`SWC` = poly_b, `Pm` = poly_pm_b, p_poly_b, p_poly_pm_b, p_c, p_pm_c) %>% 
    filter(p_poly_b < 0.05 | p_c < 0.05) %>% 
    filter(p_poly_pm_b < 0.05 | p_pm_c < 0.05) %>% 
    filter(SWC > -30) %>% # remove one outlier
    mutate(Model = 'PR', Model_stat = 'Slope')
) -> swc_surrogate_beta
swc_surrogate_beta <- outlier_test(swc_surrogate_beta,swc_surrogate_beta$Pm, swc_surrogate_beta$SWC) 

# Select R2 values
bind_rows(
  swc_results %>% select(`SWC` = first_R2, `Pm` = first_pm_R2, p_b, p_pm_b) %>% 
    filter(p_b < 0.05 & p_pm_b < 0.05) %>% 
    mutate(Model = 'LR', Model_stat = 'R2'),
  
  swc_results %>% select(`SWC` = poly_R2, `Pm` = poly_pm_R2, p_poly_b, p_poly_pm_b, p_c, p_pm_c) %>% 
    filter(p_poly_b < 0.05 | p_c < 0.05) %>% 
    filter(p_poly_pm_b < 0.05 | p_pm_c < 0.05) %>% 
    mutate(Model = 'PR', Model_stat = 'R2')
) -> swc_surrogate_r2
swc_surrogate_r2 <- outlier_test(swc_surrogate_r2, swc_surrogate_r2$Pm, swc_surrogate_r2$SWC)

# Select RMSE values
bind_rows(
  swc_results %>% select(`SWC` = slr_RMSE, `Pm` = slr_pm_RMSE, p_b, p_pm_b) %>% 
    filter(p_b < 0.05 & p_pm_b < 0.05) %>% 
    mutate(Model = 'LR', Model_stat = 'RMSE'),
  
  swc_results %>% select(`SWC` = poly_RMSE, `Pm` = poly_pm_RMSE, p_poly_b, p_poly_pm_b, p_c, p_pm_c) %>% 
    filter(p_poly_b < 0.05 | p_c < 0.05) %>% 
    filter(p_poly_pm_b < 0.05 | p_pm_c < 0.05) %>% 
    mutate(Model = 'PR', Model_stat = 'RMSE')
) -> swc_surrogate_rmse
swc_surrogate_rmse <- outlier_test(swc_surrogate_rmse, swc_surrogate_rmse$Pm, swc_surrogate_rmse$SWC)

# Select d values
bind_rows(
  swc_results %>% select(`SWC` = slr_d, `Pm` = slr_pm_d, p_b, p_pm_b) %>% 
    filter(p_b < 0.05 & p_pm_b < 0.05) %>% 
    mutate(Model = 'LR', Model_stat = 'd'),
  
  swc_results %>% select(`SWC` = poly_d, `Pm` = poly_pm_d, p_poly_b, p_poly_pm_b, p_c, p_pm_c) %>% 
    filter(p_poly_b < 0.05 | p_c < 0.05) %>% 
    filter(p_poly_pm_b < 0.05 | p_pm_c < 0.05) %>%  
    mutate(Model = 'PR', Model_stat = 'd')
) -> swc_surrogate_d
swc_surrogate_d <- outlier_test(swc_surrogate_d, swc_surrogate_d$Pm, swc_surrogate_d$SWC)

# Select EF values
bind_rows(
  swc_results %>% select(`SWC` = slr_EF, `Pm` = slr_pm_EF, p_b, p_pm_b) %>% 
    filter(p_b < 0.05 & p_pm_b < 0.05) %>% 
    mutate(Model = 'LR', Model_stat = 'EF'),
  
  swc_results %>% select(`SWC` = poly_EF, `Pm` = poly_pm_EF, p_poly_b, p_poly_pm_b, p_c, p_pm_c) %>% 
    filter(p_poly_b < 0.05 | p_c < 0.05) %>% 
    filter(p_poly_pm_b < 0.05 | p_pm_c < 0.05) %>%  
    mutate(Model = 'PR', Model_stat = 'EF')
) -> swc_surrogate_ef 

swc_surrogate_ef <- outlier_test(swc_surrogate_ef, swc_surrogate_ef$Pm, swc_surrogate_ef$SWC)

swc_surrogate <- bind_rows(swc_surrogate_beta, swc_surrogate_r2, swc_surrogate_rmse, swc_surrogate_d, swc_surrogate_ef)
  
```


#### plot results
```{r swc statistic evaluation values comparison}
# 105 site p < 0.05
swc_results %>% select(`SWC` = first_R2, `Pm` = first_pm_R2, p_b, p_pm_b) %>% 
  filter(p_b < 0.05 & p_pm_b < 0.05) %>% nrow() 

# 18 site with significant polynomial trend
swc_results %>% select(`SWC` = poly_d, `Pm` = poly_pm_d, p_poly_b, p_poly_pm_b, p_c, p_pm_c) %>% 
  filter(p_poly_b < 0.05 | p_c < 0.05) %>% 
  filter(p_poly_pm_b < 0.05 | p_pm_c < 0.05) %>% nrow()
 
swc_surrogate %>% 
  filter(Model_stat != "R2") %>%
  ggplot(aes(x = Pm, y = SWC, col = outlier )) + geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", col = "red", fill = "orange") +
  geom_abline(intercept = 0, slope = 1, col = "black", linetype = "dotdash", size = 1.25) +
  facet_wrap (Model ~ Model_stat, nrow = 2, scales = "free") +
  labs(x=expression(R[S]~"-vs-"~P[m]),
       y=expression(R[S]~"-vs-"~SWC))

# ggsave("outputs/FigureS5.jpg", width = 8, height = 5, dpi = 300, units = "in")

swc_surrogate %>% 
  filter(outlier == "No" & Model_stat != "R2") %>%
  ggplot(aes(x = Pm, y = SWC)) + 
  geom_hex(bins = 15) +
  # scale_fill_continuous(low = "gray", high = "black") +
  geom_smooth(method = "lm", col = "blue", fill = "white") +
  geom_abline(intercept = 0, slope = 1, col = "red", linetype = "dotdash", size = 0.75) +
  facet_wrap (Model ~ Model_stat, nrow = 2, scales = "free") +
  theme(legend.position = "none")+
  labs(x=expression(R[S]~"-vs-"~P[m]),
       y=expression(R[S]~"-vs-"~SWC))

# ggsave("outputs/Figure3.jpg", width = 8, height = 5, dpi = 300, units = "in")

```


## Supplemental figures for manuscript
* Linear regression to test whether Latitude, longitude, elevation, MAT, and MAP effect the surrogates
```{r}
t_results %>% mutate(p_group = ifelse(p_b <= 0.05, 1, 0)) %>% select(Study_number, SiteID, Ts_depth, Ele, Lat, Lon, MAT, MAP, Diff, p_b, p_group, Biome_group) %>%
  na.omit() -> sub_t_results

summary(lm(Diff~abs(Lat), data = sub_t_results))
summary(lm(Diff~Ts_depth, data = sub_t_results))
summary(lm(Diff~MAT, data = sub_t_results))
summary(lm(Diff~MAP, data = sub_t_results))
summary(lm(Diff~Ele, data = t_results))
summary(lm(Diff~Measure_year, data = t_results))

ggplot(data = sub_t_results, aes(Lon, Diff)) + geom_point(col = "gray", alpha=0.5) + geom_smooth(method = "lm") +
  labs(x = expression(Longitude), y = expression(SLR~R^{2}~difference))

ggplot(data = sub_t_results, aes(abs(Lat), Diff)) + geom_point(col = "gray", alpha=0.5) + geom_smooth(method = "lm") +
  labs(x = expression(Absolute~latitude), y = expression(SLR~R^{2}~difference)) -> p1

ggplot(data = sub_t_results, aes(Ts_depth, Diff)) + geom_point(col = "gray", alpha=0.5) + 
  # geom_smooth(method = "lm") +
  labs(x = expression(Tsoil~measure~depth~"(cm)"), y = expression(SLR~R^{2}~difference)) -> p2

ggplot(data = sub_t_results, aes(MAT, Diff)) + geom_point(col = "gray", alpha=0.5) + geom_smooth(method = "lm") +
  labs(x = expression(MAT~"("~degree~C~")"), y = expression(SLR~R^{2}~difference)) -> p3

ggplot(data = sub_t_results, aes(MAP, Diff)) + geom_point(col = "gray", alpha=0.5) + 
  # geom_smooth(method = "lm") +
  labs(x = expression(MAP~"(mm)"), y = expression(SLR~R^{2}~difference)) -> p4

ggplot(data = t_results, aes(Ele, Diff)) + geom_point(col = "gray", alpha=0.5) + geom_smooth(method = "lm") +
  labs(x = expression(Elevation~"(m)"), y = expression(SLR~R^{2}~difference)) -> p5

ggplot(data = t_results, aes(Measure_year, Diff)) + geom_point(col = "gray", alpha=0.5) + 
  # geom_smooth(method = "lm") +
  labs(x = expression(Measure~year), y = expression(SLR~R^{2}~difference)) -> p6

plot_grid (p1, p2, p3, p4,p5,p6, ncol = 2, labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)")
           , hjust = c(-3,-3,-3,-3,-3,-4), vjust = c(2))

# ggsave("outputs/FigureSX.jpg", dpi = 300, width = 8, height = 7, units = "in")
```


* Linear regression to test whether Latitude, longitude, elevation, MAT, and MAP effect the surrogates
```{r}
swc_results %>% select(Lat, Lon, SWCdepth, MAP, MAT, poly_R2, poly_pm_R2) %>% na.omit() %>% mutate(Diff = poly_R2 - poly_pm_R2) -> sub_swc_results

summary(lm(Diff~abs(Lat), data = sub_swc_results))
summary(lm(Diff~SWCdepth, data = sub_swc_results))
summary(lm(Diff~MAT, data = sub_swc_results))
summary(lm(Diff~MAP, data = sub_swc_results))
swc_results %>%  mutate(Diff = poly_R2 - poly_pm_R2) -> swc_results
summary(lm(Diff~Ele, data = swc_results))
summary(lm(Diff~Measure_year, data = swc_results))

ggplot(data = sub_swc_results, aes(Lon, Diff)) + geom_hex() + 
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  labs(x = expression(Longitude), y = expression(Poly~R^{2}~difference))


ggplot(data = sub_swc_results, aes(abs(Lat), Diff)) + geom_point(col="gray", alpha=0.5) + 
  # scale_fill_gradient(low = "gray", high = "blue") + theme(legend.position = "none") +
  # geom_smooth(method = "lm") +
  labs(x = expression(Absolute~latitude), y = expression(Poly~R^{2}~difference)) -> p1

ggplot(data = sub_swc_results, aes(SWCdepth, Diff)) + geom_point(col="gray", alpha=0.5) + 
  # scale_fill_gradient(low = "gray", high = "blue") + theme(legend.position = "none") +
  geom_smooth(method = "lm") +
  labs(x = expression(SWC~measure~depth~"(cm)"), y = expression(Poly~R^{2}~difference)) -> p2

ggplot(data = sub_swc_results, aes(MAT, Diff)) + geom_point(col="gray", alpha=0.5) + 
  # scale_fill_gradient(low = "gray", high = "blue") + theme(legend.position = "none") +
  geom_smooth(method = "lm") +
  labs(x = expression(MAT~"("~degree~C~")"), y = expression(Poly~R^{2}~difference)) -> p3

ggplot(data = sub_swc_results %>% filter(MAP < 5000), aes(MAP, Diff)) + geom_point(col="gray", alpha=0.5) + 
  # scale_fill_gradient(low = "gray", high = "blue") + theme(legend.position = "none") +
  geom_smooth(method = "lm") +
  labs(x = expression(MAP~"(mm)"), y = expression(Poly~R^{2}~difference)) -> p4

swc_results %>% filter(Ele <= 5000) %>% mutate(Diff = poly_R2 - poly_pm_R2) %>%  
  ggplot(aes(Ele, Diff)) + geom_point(col="gray", alpha=0.5) +
  # scale_fill_gradient(low = "gray", high = "blue") + theme(legend.position = "none") +
  geom_smooth(method = "lm") +
  labs(x = expression(Elevation~"(m)"), y = expression(Poly~R^{2}~difference)) -> p5

ggplot(data = swc_results %>% mutate(Diff = poly_R2 - poly_pm_R2), aes(Measure_year, Diff)) + geom_point(col="gray", alpha=0.5) + 
  # scale_fill_gradient(low = "gray", high = "blue") + theme(legend.position = "none") +
  geom_smooth(method = "lm") +
  labs(x = expression(Measure~year), y = expression(Poly~R^{2}~difference)) -> p6

plot_grid (p1, p2, p3, p4,p5, p6, ncol = 2, labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)")
           , hjust = c(-3,-3,-3,-3,-3,-4), vjust = c(2))

# ggsave("outputs/FigureSX.jpg", dpi = 300, width = 8, height = 7, units = "in")
```


## Supplemental figures 
### Figure S - Ts and SWC measure frequancy
```{r}
# soil temperature depth 
ggplot(DGRsD) +
  aes(TsDepth) +
  geom_histogram(fill = "gray", col = "black", bins = 30) +
  # scale_fill_gradient(low = "gray", high = "blue") +
  # geom_smooth(method = "lm") + 
  xlab(expression(Tsoil~measure~depth~"("~cm~")")) +
  ylab(expression(count)) -> p1

# SWC depth 
ggplot(subset(DGRsD, DGRsD$SWC_Type == "VWC" | DGRsD$SWC_Type == "GWC")) +
  aes(SWC_Depth) +
  geom_histogram(fill = "gray", col = "black", bins = 30) +
  # scale_fill_gradient(low = "gray", high = "blue") +
  # geom_smooth(method = "lm") + 
  xlab(expression(SWC~measure~depth~"("~cm~")")) +
  ylab(expression(count)) -> p2


# Group R2_Tsoil - R2_Tair into ()
t_results %>% mutate(Diff = first_R2 - first_Tm_R2) -> t_results
t_results %>% ggplot(aes(x = paste0("Tsoil (n=920)"), y = Diff)) + geom_violin() +  
  geom_quasirandom(alpha = I(0.05)) +
  # geom_jitter(shape = 16, position = position_jitter(0.2), col = 'gray') +
  geom_boxplot(width = 0.1, alpha = 0.1) + 
  ylab(expression(SLR~R^2~difference)) + 
  theme(axis.title.x = element_blank()
        , axis.text=element_text(size=12)
        , axis.title.y = element_text(size = 12)) -> p3

t_results %>% ggplot(aes(x = paste0("Tsoil (n=920)"), y = poly_R2 - poly_Tm_R2)) + geom_violin() +  
  # geom_jitter(shape = 16, position = position_jitter(0.2), col = 'gray') +
  geom_quasirandom(alpha = I(0.05)) +
  geom_boxplot(width = 0.1, alpha = 0.1) + 
  ylab(expression(Poly~R^2~difference)) + 
  theme(axis.title.x = element_blank()
        , axis.text=element_text(size=12)
        , axis.title.y = element_text(size = 12)) -> p4


swc_results %>% ggplot(aes(x = paste0("SWC (n=528)"), y = first_R2 - first_pm_R2)) + geom_violin() +  
  # geom_jitter(shape = 16, position = position_jitter(0.2), col = 'gray') +
  geom_quasirandom(alpha = I(0.2)) +
  geom_boxplot(width = 0.1) + 
  ylab(expression(SLR~R^2~difference)) + 
  theme(axis.title.x = element_blank()
        , axis.text=element_text(size=12)
        , axis.title.y = element_text(size = 12)) -> p5

swc_results %>% ggplot(aes(x = paste0("SWC (n=528)"), y = poly_R2 - poly_pm_R2)) + geom_violin() +  
  # geom_jitter(shape = 16, position = position_jitter(0.2), col = 'gray') +
  geom_quasirandom(alpha = I(0.2)) +
  geom_boxplot(width = 0.1) + 
  ylab(expression(Poly~R^2~difference)) + 
  theme(axis.title.x = element_blank()
        , axis.text=element_text(size=12)
        , axis.title.y = element_text(size = 12)) -> p6


quantile(t_results$Diff)
quantile(t_results$poly_R2 - t_results$poly_Tm_R2)
# t_results %>% transmute(poly_diff = poly_R2 - poly_Tm_R2) 

quantile(swc_results$first_R2 - swc_results$first_pm_R2, na.rm = T)
quantile(swc_results$poly_R2 - swc_results$poly_pm_R2, na.rm = T)

plot_grid (p1, p3, p4, p2, p5, p6, ncol = 3
           , labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)")
           , hjust = c(-3.75, -3.75,-3.85, -3.75, -3.75, -5), vjust = c(2))

# ggsave("outputs/FigureSX.jpg", dpi = 300, width = 8, height = 6, units = "in")

```


```{r Figure4}
# Rs vs Pm_Del 
SLR_T <- function (sdata, climate) {
  sdata %>% filter(!is.na(sdata$Tsoil) & !is.na(sdata$Tm_Del) & sdata$Climate_type == climate) -> subdata 
  lm(Tsoil ~ Tm_Del, data = subdata) %>% summary() %>% print()
}

SLR_T(DGRsD, "(a) Tropic")
SLR_T(DGRsD, "(b) Arid")
SLR_T(DGRsD, "(c) Temperate")
SLR_T(DGRsD, "(d) Snow")

DGRsD %>% select(Tsoil, Tm_Del, Climate_type) %>% na.omit() %>% 
  ggplot(aes(Tm_Del, Tsoil)) + geom_point(col = "gray", alpha=0.25) + 
  geom_smooth(method = "lm") +
  facet_grid(row = vars(Climate_type)) +
  labs (x = expression (Air~temperature~"("~degree~C~")")
        , y = expression (Soil~temperature~"("~degree~C~")") ) -> p1

SLR_SWCP <- function (sdata, climate) {
  sdata %>% filter(!is.na(sdata$SWC) & !is.na(sdata$Pm_Del) & sdata$Climate_type == climate) -> subdata 
  lm(SWC ~ Pm_Del, data = subdata) %>% summary() %>% print()
}

SLR_SWCP(DGRsD, "(a) Tropic")
SLR_SWCP(DGRsD, "(b) Arid")
SLR_SWCP(DGRsD, "(c) Temperate")
SLR_SWCP(DGRsD, "(d) Snow")

DGRsD %>% select(SWC, Pm_Del, Climate_type) %>% na.omit() %>% 
  ggplot(aes(Pm_Del, SWC)) + geom_point(col = "gray", alpha = 0.25) + 
  geom_smooth(method = "lm") +
  facet_grid(row = vars(Climate_type)) +
  labs (x = expression (Precipitation~"("~mm~month^{-1}~")")
        , y = expression (SWC~"(%)") ) -> p2

plot_grid(p1, p2, ncol = 2
          , hjust = c(-2), vjust = c(2))

# ggsave("outputs/Figure4.jpg", width = 8, height = 7, dpi = 300, units = "in")

```



```{r Figure-S6}
# Rs vs VWC by climate region, show very weak relationship
# linear repression and statistics
SLR_sum <- function (sdata, climate) {
  sdata %>% dplyr::filter(SWC_Type == "VWC" & !is.na(DGRsD$SWC) & DGRsD$Climate_type == climate) -> subdata 
  lm(RS_Norm ~ SWC, data = subdata) %>% summary() %>% print()
}

SLR_sum(DGRsD, "(a) Tropic")
SLR_sum(DGRsD, "(b) Arid")
SLR_sum(DGRsD, "(c) Temperate")
SLR_sum(DGRsD, "(d) Snow")

# library(dplyr)

DGRsD %>% dplyr::filter(SWC_Type == "VWC" & !is.na(DGRsD$SWC)) %>%  
  ggplot() +
  aes(x = SWC, y = RS_Norm) +
  geom_hex ( ) +
  scale_fill_gradient(low = "gray", high = "blue") +
  # geom_smooth(method = "lm") + 
  xlab(expression(SWC~"("~"%"~")")) +
  ylab(expression(R[s]~"("~g~C~m^{-2}~day^{-1}~")")) +
  facet_grid(rows = vars(Climate_type)) + 
  geom_smooth(method = "lm") +
  # annotate("text", label = c(expression(R^2~"=0.00 (p>0.05)"), expression(R^2~"=0.11 (p<0.01)"),
  #                            expression(R^2~"=0.00 (p>0.05)"), expression(R^2~"=0.05 (p>0.05)")  )
  #          , size = 4, x = 60, y = 20) +
  theme(legend.position = "none") -> plot_vwc


dat_text <- data.frame(
  label = c("R2 = 0.01 (p<0.05)", "R2 = 0.11 (p<0.01)", "R2 = 0.00 (p>0.05)", "R2 = 0.05 (p>0.05)"),
  Climate_type   = c("(a) Tropic", "(b) Arid", "(c) Temperate", "(d) Snow") )

plot_vwc <- plot_vwc + geom_text(
  data    = dat_text,
  mapping = aes(x = -Inf, y = -Inf, label = label),
  hjust   = -3,
  vjust   = -5
)

# Rs vs Pm_Del 
SLR_Pm <- function (sdata, climate) {
  sdata %>% filter(SWC_Type == "VWC" & !is.na(DGRsD$Pm_Del) & DGRsD$Climate_type == climate) -> subdata 
  lm(RS_Norm ~ Pm_Del, data = subdata) %>% summary() %>% print()
}

SLR_Pm(DGRsD, "(a) Tropic")
SLR_Pm(DGRsD, "(b) Arid")
SLR_Pm(DGRsD, "(c) Temperate")
SLR_Pm(DGRsD, "(d) Snow")


DGRsD %>% filter(SWC_Type == "VWC" & !is.na(DGRsD$SWC) & !is.na(DGRsD$Pm_Del) ) %>%
  ggplot() +
  aes(x = Pm_Del, y = RS_Norm) +
  geom_hex ( ) +
  scale_fill_gradient(low = "gray", high = "blue") +
  # geom_smooth(method = "lm") + 
  xlab(expression(Preiptation~"(mm)")) +
  ylab(expression(R[s]~"("~g~C~m^{-2}~day^{-1}~")")) +
  facet_grid(rows = vars(Climate_type)) +
  geom_smooth(method = "lm") +
  # annotate("text", label = c(expression(R^2~"=0.01 (p<0.05)"), expression(R^2~"=0.02 (p<0.01)"),
  #                            expression(R^2~"=0.05 (p<0.05)"), expression(R^2~"=0.12 (p<0.01)")  )
  #          , size = 4, x = 750, y = 20) +
  theme(legend.position = "none") -> plot_pm

dat_text <- data.frame(
  label = c("R2 = 0.01 (p<0.05)", "R2 = 0.02 (p<0.01)", "R2 = 0.05 (p<0.05)", "R2 = 0.12 (p<0.01)"),
  Climate_type   = c("(a) Tropic", "(b) Arid", "(c) Temperate", "(d) Snow") )

plot_pm <- plot_pm + geom_text(
  data    = dat_text,
  mapping = aes(x = -Inf, y = -Inf, label = label),
  hjust   = -3,
  vjust   = -5
)

plot_grid(plot_vwc, plot_pm) 
# grid.arrange(plot_vwc, plot_pm, ncol = 2)

# plot_vwc
# ggsave("outputs/FigureS6.jpg", width = 8, height = 7, dpi = 300, units = "in")

```



```{r Figure-S7}
# See how SWC measure_years
DGRsD_SWC %>% 
  filter(stringr::str_detect(SWC_Comments, 'Oven') )

DGRsD_SWC %>% mutate( SWC_Method = case_when(stringr::str_detect(SWC_Comments, 'Oven|dried|core') ~ "OvenDry" 
                                             , SWC_Comments==""|SWC_Comments=="%"|stringr::str_detect(SWC_Comments, 'Helvey') ~ "Not reported"
                                             , TRUE ~ "TDR") ) %>% select(SWC, SWC_Comments, SWC_Method, Measure_Year) %>% 
  filter(Measure_Year < 1980 & SWC_Method=="TDR")

DGRsD_SWC %>% mutate( SWC_Method = case_when(stringr::str_detect(SWC_Comments, 'Oven|dried|core') ~ "OvenDry" 
                                             , SWC_Comments==""|SWC_Comments=="%"|stringr::str_detect(SWC_Comments, 'Helvey') ~ "Not reported"
                                             , TRUE ~ "TDR") ) %>% dplyr::count(SWC_Method)

DGRsD_SWC %>% mutate( SWC_Method = case_when(stringr::str_detect(SWC_Comments, 'Oven|dried') ~ "OvenDry" 
                                             , SWC_Comments==""|stringr::str_detect(SWC_Comments, 'Helvey') ~ "Not reported"
                                             , TRUE ~ "TDR") ) %>% filter(SWC_Method=="TDR") %>% dplyr::count(SWC_Comments)


DGRsD_SWC %>% mutate( SWC_Method = case_when(stringr::str_detect(SWC_Comments, 'Oven|dried|core') ~ "Oven dry" 
                                             , SWC_Comments==""|SWC_Comments=="%"|stringr::str_detect(SWC_Comments, 'Helvey') ~ "Not reported"
                                             , TRUE ~ "TDR") ) %>% 
  ggplot(aes(Measure_Year, SWC)) + 
  # geom_point(col="gray", alpha = 0.25) + 
  geom_hex ( ) +
  scale_fill_gradient(low = "gray", high = "blue") +
  facet_grid(row = vars(SWC_Method)) +
  xlab(expression(Measure~year)) +
  ylab(expression(SWC~"(%)"))

# ggsave("outputs/FigureS7.jpg", width = 4, height = 6, units = "in", dpi = 300)

```



